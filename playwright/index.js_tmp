const express = require('express');
const { chromium } = require('playwright');
const fs = require('fs');
const path = require('path');

const app = express();
const port = 3000;

const createLocalFile = process.env.CREATE_LOCAL_FILE === 'false';

// ğŸ”§ DÃ©finition du timer pour Yahoo uniquement
const yahoo_timer = 1000; // en ms
const default_timer = 5000; // pour les autres sites

app.use(express.json());

app.post('/render', async (req, res) => {
  const { url } = req.body;
  console.log('ğŸ“¥ RequÃªte reÃ§ue avec body brut :', req.body);
  console.log('ğŸŒ URL extraite :', url);

  if (!url) return res.status(400).send('Missing URL');

  console.log('â–¶ï¸ RequÃªte reÃ§ue pour URL :', url);

  const isYahoo = url.includes('yahoo');
  const timeout = isYahoo ? yahoo_timer : default_timer;

  const browser = await chromium.launch({ headless: true });
  const page = await browser.newPage();

  try {
    await page.goto(url, { waitUntil: 'domcontentloaded' });

    // ğŸ§­ Attente DOM uniquement si ce n'est pas Yahoo
    if (!isYahoo) {
      try {
        await page.waitForSelector('body'); // ou un sÃ©lecteur plus spÃ©cifique
      } catch (err) {
        console.warn('â±ï¸ DOM wait failed (non-bloquant)', err.message);
      }
    }

    // ğŸ•’ Attente gÃ©nÃ©rique aprÃ¨s chargement
    await page.waitForTimeout(timeout);

    const html = await page.content();

    if (!createLocalFile) {
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `page-${timestamp}.html`;
      const filepath = path.join(__dirname, filename);
      fs.writeFileSync(filepath, html);
      console.log(`ğŸ’¾ Fichier sauvegardÃ© : ${filepath}`);
    }

    await browser.close();
    res.send({ data: html });

  } catch (err) {
    console.error('âŒ Erreur lors du rendu de la page :', err.message);
    await browser.close();
    res.status(500).send({ error: err.message });
  }
});

app.listen(port, () => {
  console.log(`ğŸš€ Serveur Playwright dÃ©marrÃ© sur le port ${port}`);
});
