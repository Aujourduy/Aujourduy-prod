const express = require('express');
const { chromium } = require('playwright');
const fs = require('fs');
const path = require('path');

const app = express();
const port = 3000;

// Variable d'environnement pour conditionner l'Ã©criture locale
const createLocalFile = process.env.CREATE_LOCAL_FILE === 'false';

app.use(express.json());

app.post('/render', async (req, res) => {
  const { url } = req.body;
  console.log('ðŸ“¥ RequÃªte reÃ§ue avec body brut :', req.body);
  console.log('ðŸŒ URL extraite :', url);

  if (!url) return res.status(400).send('Missing URL');

  console.log('â–¶ï¸ RequÃªte reÃ§ue pour URL :', url);

  const browser = await chromium.launch();
  const context = await browser.newContext({
    userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36'
  });
  const page = await context.newPage();

  try {
    await page.goto(url, { waitUntil: 'networkidle' });
    console.log('âœ… Page principale chargÃ©e');

    await page.waitForSelector('iframe');
    const frames = page.frames();
    const frame = frames.find(f => f.url().includes('multi_event.php') && f.url().includes('multi='));

    if (!frame) {
      throw new Error("âŒ iframe non trouvÃ©e dans la page");
    }

    console.log('ðŸ”— URL rÃ©elle de lâ€™iframe :', frame.url());

    await frame.evaluate(async () => {
      await new Promise((resolve) => {
        let totalHeight = 0;
        const distance = 100;
        const timer = setInterval(() => {
          window.scrollBy(0, distance);
          totalHeight += distance;
          if (totalHeight >= document.body.scrollHeight) {
            clearInterval(timer);
            resolve();
          }
        }, 200);
      });
    });

    await page.waitForTimeout(3000);

    const fullHtml = await frame.content();
    console.log('ðŸ“¦ HTML de lâ€™iframe rÃ©cupÃ©rÃ©, taille :', fullHtml.length);

    if (createLocalFile) {
      // Si CREATE_LOCAL_FILE est activÃ©, Ã©crire les fichiers

      // ðŸ”¹ Sauvegarde 1 : nom dynamique depuis lâ€™URL
      const fileName = url.replace(/[^a-z0-9]/gi, '_').toLowerCase();
      const filePath = path.join(__dirname, `${fileName}_iframe.html`);
      fs.writeFileSync(filePath, fullHtml);
      console.log(`ðŸ’¾ Fichier HTML sauvegardÃ© : ${filePath}`);

      // ðŸ”¹ Sauvegarde 2 : nom horodatÃ© dans /outputs
      const now = new Date();
      const timestamp = now.toISOString().replace(/T/, '-').replace(/:/g, '-').split('.')[0]; // YYYY-MM-DD-HH-MM-SS
      const datedFileName = `playwright-result_${timestamp}.html`;
      const datedFilePath = path.join(__dirname, 'outputs', datedFileName);

      // S'assurer que le rÃ©pertoire "outputs" existe
      if (!fs.existsSync(path.dirname(datedFilePath))) {
        fs.mkdirSync(path.dirname(datedFilePath), { recursive: true });
      }

      fs.writeFileSync(datedFilePath, fullHtml);
      console.log(`ðŸ’¾ Fichier HTML horodatÃ© sauvegardÃ© : ${datedFilePath}`);
    } else {
      console.log('ðŸš« CREATE_LOCAL_FILE est dÃ©sactivÃ©, aucun fichier nâ€™a Ã©tÃ© sauvegardÃ©.');
    }

    res.send(fullHtml);
  } catch (error) {
    console.error('âŒ Erreur :', error);
    res.status(500).send('Erreur lors du rendu');
  } finally {
    await browser.close();
    console.log('ðŸ§¹ Navigateur fermÃ©');
  }
});

app.listen(port, () => {
  console.log(`âœ… API Playwright en Ã©coute sur http://localhost:${port}`);
});
