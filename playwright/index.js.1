const express = require('express');
const { chromium } = require('playwright');
const fs = require('fs');
const path = require('path');

const app = express();
const port = 3000;

const createLocalFile = process.env.CREATE_LOCAL_FILE === 'false';

app.use(express.json());

app.post('/render', async (req, res) => {
  const { url } = req.body;
  console.log('ðŸ“¥ RequÃªte reÃ§ue avec body brut :', req.body);
  console.log('ðŸŒ URL extraite :', url);

  if (!url) return res.status(400).send('Missing URL');

  console.log('â–¶ï¸ RequÃªte reÃ§ue pour URL :', url);

  const browser = await chromium.launch();
  const context = await browser.newContext({
    userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36',
  });

  // Anti-bot : masquer `navigator.webdriver`
  await context.addInitScript(() => {
    Object.defineProperty(navigator, 'webdriver', {
      get: () => false,
    });
  });

  const page = await context.newPage();

  try {
    await page.goto(url, { waitUntil: 'networkidle' });
    console.log('âœ… Page principale chargÃ©e');

    // DÃ©sactiver les animations CSS pour fiabiliser la capture
    await page.emulateMedia({ reducedMotion: 'reduce' });

    // Screenshot avec timeout Ã©tendu
    const screenshotPath = path.join(__dirname, 'outputs', 'last_screenshot.png');
    if (!fs.existsSync(path.dirname(screenshotPath))) {
      fs.mkdirSync(path.dirname(screenshotPath), { recursive: true });
    }

    try {
      await page.screenshot({
        path: screenshotPath,
        fullPage: true,
        timeout: 60000, // timeout Ã©tendu Ã  60s
      });
      console.log('ðŸ“¸ Screenshot capturÃ© :', screenshotPath);
    } catch (e) {
      console.error('âŒ Ã‰chec de la capture dâ€™Ã©cran :', e);
    }

    // RÃ©cupÃ©rer tous les frames
    const frames = page.frames();
    console.log('ðŸ” Frames dÃ©tectÃ©s :');
    frames.forEach(f => console.log(' - ', f.url()));

    // On tente de trouver une iframe pertinente
    const frame = frames.find(f => f.url().includes('multi_event.php') && f.url().includes('multi='));

    let htmlContent;
    if (frame) {
      console.log('ðŸ”— Iframe ciblÃ©e trouvÃ©e :', frame.url());

      await frame.evaluate(async () => {
        await new Promise((resolve) => {
          let totalHeight = 0;
          const distance = 100;
          const timer = setInterval(() => {
            window.scrollBy(0, distance);
            totalHeight += distance;
            if (totalHeight >= document.body.scrollHeight) {
              clearInterval(timer);
              resolve();
            }
          }, 200);
        });
      });

      await page.waitForTimeout(3000);
      htmlContent = await frame.content();
    } else {
      console.log('âš ï¸ Aucune iframe spÃ©cifique trouvÃ©e, fallback sur le contenu principal');
      await page.waitForTimeout(2000);
      htmlContent = await page.content();
    }

    console.log('ðŸ“¦ HTML rÃ©cupÃ©rÃ©, taille :', htmlContent.length);

    if (createLocalFile) {
      const fileName = url.replace(/[^a-z0-9]/gi, '_').toLowerCase();
      const filePath = path.join(__dirname, `${fileName}.html`);
      fs.writeFileSync(filePath, htmlContent);
      console.log(`ðŸ’¾ Fichier HTML sauvegardÃ© : ${filePath}`);

      const now = new Date();
      const timestamp = now.toISOString().replace(/T/, '-').replace(/:/g, '-').split('.')[0];
      const datedFileName = `playwright-result_${timestamp}.html`;
      const datedFilePath = path.join(__dirname, 'outputs', datedFileName);
      if (!fs.existsSync(path.dirname(datedFilePath))) {
        fs.mkdirSync(path.dirname(datedFilePath), { recursive: true });
      }
      fs.writeFileSync(datedFilePath, htmlContent);
      console.log(`ðŸ’¾ Fichier HTML horodatÃ© sauvegardÃ© : ${datedFilePath}`);
    } else {
      console.log('ðŸš« CREATE_LOCAL_FILE dÃ©sactivÃ©, aucun fichier sauvegardÃ©');
    }

    res.send(htmlContent);
  } catch (error) {
    console.error('âŒ Erreur :', error);
    res.status(500).send('Erreur lors du rendu');
  } finally {
    await browser.close();
    console.log('ðŸ§¹ Navigateur fermÃ©');
  }
});

app.listen(port, () => {
  console.log(`âœ… API Playwright en Ã©coute sur http://localhost:${port}`);
});
