<div class="space-y-6">
  <!-- Section Avatar -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <h2 class="card-title">Photo de profil</h2>
      
      <div class="flex flex-col items-center">
        <div class="w-32 h-32 rounded-full overflow-hidden bg-base-200 mb-4">
          <% if current_user.avatar_url %>
            <%= image_tag current_user.avatar_url(:medium),
                alt: "Avatar", class: "w-full h-full object-cover" %>
          <% else %>
            <div class="w-full h-full flex items-center justify-center text-base-content/40">
              <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg>
            </div>
          <% end %>
        </div>
        
        <button id="upload_avatar_widget" type="button" class="btn btn-primary">
          üì∏ Uploader et recadrer mon avatar
        </button>
        
        <p class="text-xs text-base-content/60 mt-2 text-center max-w-md">
          ‚ö†Ô∏è Apr√®s avoir s√©lectionn√© votre image, ajustez le cadrage puis cliquez sur "Done" pour confirmer.
        </p>
      </div>
    </div>
  </div>

  <!-- Formulaire Devise -->
  <%= form_for(current_user, as: :user, url: registration_path(:user), html: { method: :patch, class: "space-y-6" }) do |f| %>
    <%= f.hidden_field :avatar_cloudinary_id, id: "user_avatar_cloudinary_id" %>
    
    <!-- Informations personnelles -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body space-y-4">
        <h2 class="card-title">Informations personnelles</h2>
        
        <div class="form-control">
          <%= f.label :first_name, "Pr√©nom", class: "label" %>
          <%= f.text_field :first_name, autofocus: true, class: "input input-bordered w-full" %>
        </div>
        
        <div class="form-control">
          <%= f.label :last_name, "Nom", class: "label" %>
          <%= f.text_field :last_name, class: "input input-bordered w-full" %>
        </div>
        
        <div class="form-control">
          <%= f.label :email, "Email", class: "label" %>
          <%= f.email_field :email, autocomplete: "email", class: "input input-bordered w-full" %>
        </div>
      </div>
    </div>
    
    <!-- Changer le mot de passe -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body space-y-4">
        <h2 class="card-title">Modifier le mot de passe</h2>
        <p class="text-sm text-base-content/70">Laissez vide si vous ne souhaitez pas changer</p>
        
        <div class="form-control">
          <%= f.label :password, "Nouveau mot de passe", class: "label" %>
          <%= f.password_field :password, autocomplete: "new-password", class: "input input-bordered w-full", placeholder: "Laisser vide si inchang√©" %>
          <% if @minimum_password_length %>
            <label class="label">
              <span class="label-text-alt"><%= @minimum_password_length %> caract√®res minimum</span>
            </label>
          <% end %>
        </div>
        
        <div class="form-control">
          <%= f.label :password_confirmation, "Confirmation du nouveau mot de passe", class: "label" %>
          <%= f.password_field :password_confirmation, autocomplete: "new-password", class: "input input-bordered w-full" %>
        </div>
      </div>
    </div>
    
    <!-- Confirmation -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body space-y-4">
        <h2 class="card-title">Confirmer les modifications</h2>
        
        <div class="form-control">
          <%= f.label :current_password, "Mot de passe actuel", class: "label" %>
          <%= f.password_field :current_password, autocomplete: "current-password", class: "input input-bordered w-full" %>
          <label class="label">
            <span class="label-text-alt">Requis pour confirmer les modifications</span>
          </label>
        </div>
        
        <%= f.submit "üíæ Enregistrer les modifications", class: "btn btn-primary btn-lg w-full" %>
      </div>
    </div>
  <% end %>
  
  <!-- Danger zone -->
  <div class="card bg-error/10 border border-error/20 shadow-xl">
    <div class="card-body">
      <h2 class="card-title text-error">Zone dangereuse</h2>
      <p class="text-sm text-base-content/70 mb-4">
        Cette action est irr√©versible et supprimera d√©finitivement votre compte.
      </p>
      <%= button_to "üóëÔ∏è Supprimer mon compte", 
          registration_path(:user), 
          method: :delete,
          data: { 
            turbo_confirm: "√ätes-vous absolument s√ªr(e) ? Cette action est IRR√âVERSIBLE."
          }, 
          class: "btn btn-error btn-outline" %>
    </div>
  </div>
</div>

<!-- Script Cloudinary -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
<script>
(function() {
  function initCloudinaryAvatarWidget() {
    const btn = document.getElementById("upload_avatar_widget");
    if (!btn || btn.dataset.cldInit === "1") return;
    
    var myWidget = cloudinary.createUploadWidget({
      cloudName: "<%= ENV["CLOUDINARY_CLOUD_NAME"] %>",
      uploadPreset: "avatars_crop",
      cropping: true,
      croppingAspectRatio: 1,
      showSkipCropButton: false,
      multiple: false,
      sources: ['local', 'url'],
      language: "fr",
      folder: "avatars"
    }, (error, result) => {
      if (!error && result && result.event === "success") {
        let imageUrl = result.info.secure_url;
        if (result.info.eager && result.info.eager.length > 0) {
          imageUrl = result.info.eager[0].secure_url;
        }
        document.querySelector("#user_avatar_cloudinary_id").value = result.info.public_id;
        const avatarContainer = document.querySelector(".w-32.h-32.rounded-full.overflow-hidden");
        avatarContainer.innerHTML = `<img src="${imageUrl}" alt="Avatar" class="w-full h-full object-cover">`;
        alert("Avatar recadr√© avec succ√®s ! N'oubliez pas de cliquer sur 'Enregistrer les modifications'.");
      }
    });
    
    btn.addEventListener("click", function(e){
      e.preventDefault();
      myWidget.open();
    });
    btn.dataset.cldInit = "1";
  }
  
  document.addEventListener("turbo:load", initCloudinaryAvatarWidget);
  document.addEventListener("DOMContentLoaded", initCloudinaryAvatarWidget);
})();
</script>
