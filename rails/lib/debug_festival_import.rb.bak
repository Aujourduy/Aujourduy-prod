# Script de debug pour analyser l'Ã©chec d'import de "FESTIVAL 2026"

puts "ğŸ” Recherche de l'Ã©vÃ©nement 'FESTIVAL 2026'..."

# Chercher le ScrapedEvent avec ce titre
scraped_event = ScrapedEvent.where("json_data->>'event' IS NOT NULL")
  .find { |se| se.json_data.dig('event', 'title')&.include?('FESTIVAL') }

if scraped_event
  puts "\nâœ… Ã‰vÃ©nement trouvÃ© : #{scraped_event.id}"
  puts "   Titre : #{scraped_event.json_data.dig('event', 'title')}"
  puts "   Statut : #{scraped_event.status}"
  puts "   ValidÃ© par : #{scraped_event.validated_by_id}"

  puts "\nğŸ“‹ DonnÃ©es JSON complÃ¨tes :"
  puts JSON.pretty_generate(scraped_event.json_data)

  puts "\nğŸ§ª Test d'import..."
  service = ScrapedEventImportService.new(scraped_event)
  result = service.import!

  puts "\nğŸ“Š RÃ©sultat :"
  puts "   SuccÃ¨s : #{result}"

  if service.errors.any?
    puts "\nâŒ ERREURS DÃ‰TECTÃ‰ES :"
    service.errors.each do |error|
      puts "   - #{error}"
    end
  else
    puts "\nâœ… Aucune erreur !"
  end

  # Afficher aussi les erreurs de l'EventImportService
  if service.import_service.errors.any?
    puts "\nâŒ Erreurs EventImportService :"
    service.import_service.errors.each do |error|
      puts "   - #{error}"
    end
  end

  # VÃ©rifier les donnÃ©es manquantes
  puts "\nğŸ” VÃ©rification des champs requis :"
  event_data = scraped_event.json_data['event']
  required_fields = %w[title description practice source_url price_normal price_reduced currency start_date start_time end_time]

  required_fields.each do |field|
    value = event_data[field]
    if value.present?
      puts "   âœ… #{field} : #{value}"
    else
      puts "   âŒ #{field} : MANQUANT"
    end
  end

  # VÃ©rifier le teacher
  puts "\nğŸ‘¨â€ğŸ« VÃ©rification Teacher :"
  teacher_data = scraped_event.json_data['teacher']
  if teacher_data
    puts "   RecherchÃ© : #{teacher_data['first_name']} #{teacher_data['last_name']}"
    teacher = Teacher.find_by(
      first_name: teacher_data['first_name'],
      last_name: teacher_data['last_name']
    )
    if teacher
      puts "   âœ… TrouvÃ© : #{teacher.display_name}"
    else
      puts "   âŒ NON TROUVÃ‰ dans la base"
    end
  else
    puts "   âŒ Teacher data manquant"
  end

  # VÃ©rifier la practice
  puts "\nğŸ§˜ VÃ©rification Practice :"
  practice_name = event_data['practice']
  if practice_name
    puts "   RecherchÃ©e : #{practice_name}"
    practice = Practice.where('LOWER(name) = ?', practice_name.downcase).first
    if practice
      puts "   âœ… TrouvÃ©e : #{practice.name}"
    else
      puts "   âŒ NON TROUVÃ‰E dans la base"
    end
  else
    puts "   âŒ Practice manquante"
  end

else
  puts "\nâŒ Aucun Ã©vÃ©nement trouvÃ© avec 'FESTIVAL' dans le titre"
  puts "\nğŸ“‹ Liste des Ã©vÃ©nements validÃ©s :"
  ScrapedEvent.validated.each do |se|
    title = se.json_data.dig('event', 'title')
    puts "   - #{title} (ID: #{se.id})"
  end
end
