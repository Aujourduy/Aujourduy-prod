# CONTEXTE DU PROJET

Je dÃ©veloppe un site d'agenda de cours de danses libres (5 rythmes, ecstatic dance, contact impro).

## STACK TECHNIQUE
- **Backend** : Rails sous Docker Compose (dossier ~/Aujourduy/)
- **Projet Rails** : ~/Aujourduy/rails/
- **Base de donnÃ©es** : PostgreSQL + PGBouncer
- **Frontend** : Tailwind CSS + DaisyUI (mobile-first PWA)
- **Authentification** : Devise + Google OAuth
- **Automation** : N8N (dans le mÃªme docker-compose)
- **IA** : Alibaba Qwen API (rÃ©gion Singapour, 90 jours gratuit)

## MODÃˆLES DE DONNÃ‰ES
- **User** : authentification avec droits CRUD
- **Teacher** : professeur(s) de cours
- **Event** : Ã©vÃ©nement de danse
- **EventOccurrence** : occurrences des cours (uniques ou rÃ©currents)
- **Venue** : lieu

## OBJECTIF ACTUEL
Utiliser **N8N + Qwen API** pour extraire automatiquement les informations d'ateliers de danse depuis des pages HTML et crÃ©er les Events dans Rails.

---

# CE QUI A Ã‰TÃ‰ VALIDÃ‰

## 1. API QWEN FONCTIONNELLE âœ…
- **API Key** : ConfigurÃ©e et testÃ©e
- **ModÃ¨le choisi** : `qwen-flash` (parfait pour notre usage)
- **Endpoint** : https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions
- **CoÃ»t** : ~$0.0013 par extraction (~3400 tokens)
- **Quota gratuit** : 1 million tokens pendant 90 jours

## 2. PROMPT QWEN OPTIMAL TESTÃ‰ âœ…

```json
{
  "model": "qwen-flash",
  "messages": [
    {
      "role": "system",
      "content": "Expert extraction. RÃ©ponds en JSON pur sans markdown. RÃˆGLE: Pour Ã©vÃ©nements rÃ©currents avec plusieurs dates, crÃ©e UN Ã©vÃ©nement SÃ‰PARÃ‰ pour CHAQUE date. Pour 'tous les vendredis', gÃ©nÃ¨re au moins les 4 premiÃ¨res occurrences."
    },
    {
      "role": "user",
      "content": "Extrait tous les ateliers/cours/stages de danse.\n\nCRÃ‰E UN Ã‰VÃ‰NEMENT DISTINCT PAR DATE pour les rÃ©currents.\n\nChamps JSON:\n- titre\n- description\n- date_debut (YYYY-MM-DD)\n- date_fin (YYYY-MM-DD ou null si 1 jour)\n- horaire (ex: '19h30-21h30')\n- prix (nombre ou null) : prix plein\n- prix_reduit (nombre ou null) : si format '20â‚¬/17â‚¬' â†’ prix:20, prix_reduit:17\n- pays\n- ville\n- adresse\n- nom_lieu\n- type ('5 rythmes', 'ecstatic dance', 'contact impro' ou 'autre')\n- professeur (nom du prof, 'Marc Silvestre' par dÃ©faut si non mentionnÃ©)\n\nRÃ©ponds: {\"events\": [...]}\n\n=== TEXTE Ã€ ANALYSER ===\n[INSÃ‰RER HTML NETTOYÃ‰ ICI]"
    }
  ]
}
```

## 3. TEST RÃ‰USSI SUR SITE RÃ‰EL âœ…
- **Site testÃ©** : https://www.marcsilvestre.com/agenda-cours-stages-1
- **RÃ©sultat** : 20 Ã©vÃ©nements extraits correctement
- **Points forts** :
  - Un Ã©vÃ©nement par date pour les rÃ©currents (âœ… VAGUES Paris : 4 vendredis sÃ©parÃ©s)
  - Dates au format ISO (âœ…)
  - Prix et prix_reduit extraits (âœ…)
  - Lieux et adresses complets (âœ…)
  - Stages multi-jours avec date_fin (âœ…)

---

# ARCHITECTURE N8N â†’ RAILS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  N8N WORKFLOW                       â”‚
â”‚  1. Trigger (manuel/cron/webhook)  â”‚
â”‚  2. HTTP: Fetch HTML page          â”‚
â”‚  3. Code: Clean HTML (enlever CSS) â”‚
â”‚  4. HTTP: Call Qwen API            â”‚
â”‚  5. Code: Parse JSON response      â”‚
â”‚  6. HTTP: POST to Rails API        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAILS API                          â”‚
â”‚  POST /api/events/import            â”‚
â”‚  - Auth avec API token              â”‚
â”‚  - Validation donnÃ©es               â”‚
â”‚  - Create Event/Teacher/Venue       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# MES CONSIGNES DE TRAVAIL

**PROCESSUS OBLIGATOIRE :**
1. Tu me dis quels fichiers te montrer
2. Tu me donnes la commande `cat` avec le chemin complet depuis ~/Aujourduy/
3. Je te fais un `cat nom_du_fichier`
4. Tu me donnes **UNE SEULE** commande qui combine `rm && cat > fichier << 'EOF'` pour remplacer

**CONTRAINTES :**
- Mon dossier courant : `~/Aujourduy/`
- Tous les chemins relatifs depuis ~/Aujourduy/
- Format obligatoire : `rm fichier && cat > fichier << 'EOF' (contenu) EOF`
- Une seule manipulation par modification
- Commandes Docker : `docker compose -f ~/Aujourduy/docker-compose.yml exec rails rails ...`

**ALIAS DISPONIBLES :**
- `drails` = docker compose rails exec
- `lsr` = ls rÃ©cursif
- `catr` = cat rÃ©cursif

**DESIGN :**
- DaisyUI avec thÃ¨mes clair/sombre
- Utiliser `.card-custom` pour les cartes
- Couleurs : `theme('colors.xxx')` pas `hsl()`

---

# PROCHAINES Ã‰TAPES

## 1. WORKFLOW N8N COMPLET (Ã€ CODER)
- [ ] Node 1 : Manual Trigger ou Cron
- [ ] Node 2 : HTTP Request - Fetch HTML
- [ ] Node 3 : Code - Clean HTML (retirer CSS/JS)
- [ ] Node 4 : HTTP Request - Call Qwen API (avec prompt optimal)
- [ ] Node 5 : Code - Parse response JSON
- [ ] Node 6 : HTTP Request - POST vers Rails /api/events/import

## 2. ENDPOINT API RAILS (Ã€ CRÃ‰ER)
- [ ] Routes : `POST /api/events/import`
- [ ] Controller : `Api::EventsController#import`
- [ ] Authentification : API token
- [ ] Service : parser JSON et crÃ©er Event/Teacher/Venue/EventOccurrence
- [ ] Gestion des doublons (mÃªme event, mÃªme date)

## 3. VOIR LES FICHIERS RAILS ACTUELS
J'ai besoin de voir pour crÃ©er l'endpoint API :
```bash
cat ./rails/db/schema.rb
cat ./rails/config/routes.rb
find ./rails/app/models -name "*.rb" -exec echo "=== {} ===" \; -exec cat {} \;
find ./rails/app/controllers -name "*.rb" -exec echo "=== {} ===" \; -exec cat {} \;
```

---

# QUESTIONS Ã€ ME POSER

1. **On commence par quoi ?**
   - A) Le workflow N8N complet (JSON Ã  importer)
   - B) L'endpoint API Rails d'abord
   - C) Voir les fichiers Rails existants avant tout

2. **Authentification API** : Quel type prÃ©fÃ¨res-tu ?
   - Token Bearer dans header ?
   - API key simple ?
   - Basic auth ?

3. **Gestion des doublons** : Si mÃªme event + mÃªme date existe dÃ©jÃ  ?
   - Skip silencieusement
   - Update si diffÃ©rent
   - Erreur

---

# COMMANDES UTILES

```bash
# Variables d'environnement
API_KEY="sk-xxxxx"  # API Key Qwen

# Test Qwen direct
curl -X POST https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions \
  -H "Authorization: Bearer ${API_KEY}" \
  -H "Content-Type: application/json" \
  -d '{"model":"qwen-flash","messages":[...]}'

# Rails console
docker compose -f ~/Aujourduy/docker-compose.yml exec rails rails c

# Logs Rails
docker compose -f ~/Aujourduy/docker-compose.yml logs -f rails
```

---

**JE SUIS PRÃŠT Ã€ CONTINUER ! Par quoi veux-tu qu'on commence ?** ðŸš€